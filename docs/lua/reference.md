# Lua 5.4 参考手册

## 1. 简介

Lua是一种功能齐全、执行高效、轻量级、可嵌入的脚本语言。支持面向过程、面向对象、函数式、数据驱动、资料定义等多种编程范式。

Lua具有简洁的过程语法、强大的字典数据结构、以及高度可扩展的语义。Lua是动态类型语言，通过寄存器虚拟机解释字节码运行，并具有自动内存管理和迭代式的垃圾回收机制，所以非常适合用于配置、逻辑脚本和快速原型的开发。

Lua以库的形式存在，基于Clean C(标准C和C++的公共子集)开发。Lua的发布版本中也有一个包含完整库和独立Lua解释器，可用于交互式和批处理使用的可执行文件`lua`。因此Lua既可以作为功能强大且轻量级的脚本语言嵌入到其他宿主程序，也可以作为功能强大、轻量级的独立语言。

作为扩展语言，Lua没有`main`函数的概念：它能潜入到其他程序中，这个被嵌入的程序称为宿主；或者作为独立程序使用，这个独立程序通常是指单独的`lua`可执行文件。可以执行一段Lua代码，可以写入或者读取Lua变量，也可以注册C函数给Lua使用。通过使用C函数，Lua可以增强其应对各种不同领域的能力，从而创建共享语法框架的定制编程语言。

Lua是开源免费软件，遵循Lua许可证(MIT许可证)发布。手册中描述的实现可在Lua的官方网站[lua.org](https://www.lua.org/)找到。

跟其他参考手册一样，本文档会比较枯燥。关于Lua背后设计原理，可以参考Lua网站上的[技术论文](https://www.lua.org/papers.html)。有关Lua编程更详细介绍，可以参考Roberto的[《Lua程序设计》](https://www.lua.org/pil/)。

## 2. 基本概念

本章节介绍Lua语言的基本概念。

### 2.1 值和类型

Lua是一种动态类型语言。这意味着变量没有类型；只有值才有类型。该语言没有类型定义。所有值都有自己的类型。

Lua中的所有值都是第一类型值。这意味着所有值都可以存储在变量中、作为参数才传递给其他函数，以及作为结果返回。

Lua中有8种基本类型：`nil`、`boolean`、`number`、`string`、`function`、`userdata`、`thread`、`table`。类型`nil`具有一个单一值`nil`，其主要特性是不同于任何其他值；它通常代表无效值。`boolean`类型有2个值：`true`和`false`。`nil`和`false`会导致条件为假；他们统称为假`值`。其他值都为`真`。虽然名称如此，在Lua中条件`假`经常用于`nil`的判定，其主要区别在于`false`表现得像表中的常规值，而`nil`表示缺失的值。

`number`类型既表示整数，又表示实数（浮点数），使用两种子类型：`integer`和`float`。标准Lua实现使用64位整数和双精度（64位）浮点数，但也可以编译Lua使用32位整数和单精度（32位）浮点数。对于小型机器和嵌入式系统来说，32位整数和单精度浮点数是更合适的。（可以参考luaconf.h中的宏 LUA_32BITS 。）

除非特别说明，否则，根据二进制补码算数的通常规则，操作整数值时的任何溢出都会回绕。（换句话说，实际结果是唯一可表示的整数，它与数学结果模 2n 相等，其中 n 是整数类型的位数。）

Lua 对于何时使用每种子类型有明确的规则，但它也会根据需要自动在它们之间进行转换（参见 §3.4.3）。因此，程序员可以选择忽略整数和浮点数之间的差异，或者完全控制每个数字的表示。

类型字符串表示不可变的字节序列。Lua 是 8 位字符：字符串可以包含任何 8 位值，包括嵌入的零（'\0'）。Lua 也是与编码无关的；它对字符串的内容不做任何假设。Lua 中任何字符串的长度都必须符合 Lua 整数的长度。

Lua 可以调用（并操作）用 Lua 编写的函数和用 C 编写的函数（参见 §3.4.10）。两者都用 function 类型表示。

提供 `userdata` 类型以允许将任意 C 数据存储在 Lua 变量中。`userdata`代表一块原始内存。有两种类型的`userdata`：`full userdata`即由Lua管理的一块内存的数据，`light userdata`它只是一个C指针值。除了赋值和类型检测外，Lua 不提供任何操作 `userdata` 的机制。通过使用`metatables`，程序员可以定义对`full userdata`的操作（参见§2.4）。在 Lua 中无法创建或修改`usedata`，只能通过 C API 进行创建或修改。这保证了宿主程序和 C 库所拥有的数据的完整性。

类型 `thread` 代表独立的执行线程，它用于实现协同程序（参见§2.6）。Lua 线程与操作系统线程无关。Lua 支持所有系统上的协程，即使是那些本身不支持线程的系统。

类型 `table` 实现关联数组，即数组不仅可以以数字作为索引，还可以以除 `nil` 和 `NaN`(非数字是 IEEE 754 标准使用的特殊浮点值，用于表示未定义的数值结果，例如 0/0。) 之外的任何 Lua 值作为索引。`table` 可以是异构的；也就是说，它们可以包含所有类型的值（除了 `nil`）。与值 nil 关联的任何`key`均不被视为表的一部分。相反，任何不属于表的`key`都具有关联值 nil。



### 2.2 环境变量

### 2.3 错误处理

### 2.4 元表和元方法

### 2.5 垃圾回收

#### 2.5.1 增量式回收

#### 2.5.2 迭代式回收

#### 2.5.3 元方法回收

#### 2.5.4 弱表回收

### 2.6 协程

## 3. 语言

### 3.1 约定

### 3.2 变量

### 3.3 语句

#### 3.3.1 语句块

#### 3.3.2 代码块

#### 3.3.3 赋值

#### 3.3.4 控制结构

#### 3.3.5 For 循环

#### 3.3.6 函数调用

#### 3.3.7 局部声明

#### 3.3.8 待回收变量

### 3.4 表达式

#### 3.4.1 算术运算符

#### 3.4.2 位运算

#### 3.4.3 类型转换

#### 3.4.4 关系运算符

#### 3.4.5 逻辑运算符

#### 3.4.6 连接运算符

#### 3.4.7 长度运算符

#### 3.4.8 运算符优先级

#### 3.4.9 表构造器

#### 3.4.10 函数调用

#### 3.4.11 函数定义

#### 3.4.12 语句列表、多返回值及其调整

### 3.5 作用范围

## 4. C接口

### 4.1 堆栈

#### 4.1.1 堆栈大小

#### 4.1.2 有效索引

#### 4.1.3 字符串指针

### 4.2 闭包

### 4.3 注册表

### 4.4 错误处理函数

#### 4.4.1 状态码

### 4.5 协同程序

### 4.6 函数和类型

### 4.7 调试接口

## 5. 库函数

### 5.1 函数和类型

## 6. 标准库

### 6.1 基础函数

### 6.2 协程操作

### 6.3 模块

### 6.4 字符串操作

#### 6.4.1 模式匹配

#### 6.4.2 格式化

### 6.5 UTF-8 支持

### 6.6 表操作

### 6.7 数学函数

### 6.8 输入输出

### 6.9 操作系统

### 6.10 调试库

## 7. 独立程序

## 8. 兼容性

### 8.1 语言不

### 8.2 库

### 8.3 API

## 9. 完整语法
